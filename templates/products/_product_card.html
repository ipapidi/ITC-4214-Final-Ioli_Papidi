{# Usage: include with product=product #}
{% load static %}
<div class="product-card" data-product-url="{% url 'products:product_detail' product.slug %}">
    <div class="product-image position-relative">
        {% if product.main_image %}
        <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="img-fluid rounded">
        {% else %}
        <div class="placeholder-image">
            <i class="fas fa-image fa-3x"></i>
        </div>
        {% endif %}
        <!-- Wishlist Heart Icon (toggle) -->
        <div class="wishlist-heart position-absolute top-0 end-0 m-2">
            {% if user.is_authenticated %}
                <button type="button"
                    class="btn {% if product.is_in_wishlist %}btn-danger{% else %}btn-outline-danger{% endif %} rounded-circle"
                    title="{% if product.is_in_wishlist %}Remove from Wishlist{% else %}Add to Wishlist{% endif %}"
                    onclick="toggleWishlist({{ product.id|escapejs }}, {{ product.is_in_wishlist|yesno:'true,false' }}, this)">
                    {% if product.is_in_wishlist %}
                        <i class="fas fa-heart"></i>
                    {% else %}
                        <i class="far fa-heart"></i>
                    {% endif %}
                </button>
            {% else %}
                <a href="{% url 'users:login' %}?next={{ request.get_full_path|urlencode }}" 
                   class="btn btn-outline-danger rounded-circle"
                   title="Login to add to Wishlist">
                    <i class="far fa-heart"></i>
                </a>
            {% endif %}
        </div>
        {% if product.is_on_sale %}
        <div class="sale-badge text-danger">SALE</div>
        {% endif %}
    </div>
    <div class="product-info">
        <h4 class="product-name">{{ product.name }}</h4>
        <div class="product-brand">{{ product.brand.name }}</div>
        <div class="product-category">{{ product.category.name }}</div>
        <div class="product-rating">
            <span class="stars">
                {% if product.annotated_avg_rating is not None %}
                    {% with avg=product.annotated_avg_rating %}
                        {% include 'products/_product_card_stars.html' with avg=avg %}
                    {% endwith %}
                {% elif product.average_rating %}
                    {% with avg=product.average_rating %}
                        {% include 'products/_product_card_stars.html' with avg=avg %}
                    {% endwith %}
                {% else %}
                    <span class="text-danger">No ratings yet.</span>
                {% endif %}
            </span>
        </div>
        <div class="product-price">
            {% if product.is_on_sale %}
            <span class="original-price">${{ product.price }}</span>
            <span class="current-price text-danger fw-bold">${{ product.sale_price }}</span>
            {% else %}
            <span class="current-price">${{ product.price }}</span>
            {% endif %}
        </div>
        <div class="product-stock mb-2">
            {% if product.stock_status == 'out_of_stock' %}
                <span class="text-danger" style="font-weight:bold;">Out of Stock</span>
            {% elif product.stock_status == 'low_stock' %}
                <span style="color:#ffc107; font-weight:bold;">Low Stock ({{ product.stock_quantity }})</span>
            {% else %}
                <span class="text-success" style="font-weight:bold;">In Stock ({{ product.stock_quantity }})</span>
            {% endif %}
        </div>
        <div class="non-clickable">
            <a href="{% url 'products:product_detail' product.slug %}" class="btn btn-outline-primary w-100 mt-2">
                View Details
            </a>
            {% if not hide_add_to_cart %}
                {% if user.is_authenticated %}
                <form method="post" action="{% url 'orders:add_to_cart' product.id %}" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger w-100" {% if product.stock_quantity == 0 %}disabled{% endif %}>
                        Add to Cart
                    </button>
                </form>
                {% else %}
                <a href="{% url 'users:login' %}?next={{ request.get_full_path|urlencode }}" class="btn btn-danger w-100 mt-2">Add to Cart</a>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script src="{% static 'js/products_product_card.js' %}" defer></script>

